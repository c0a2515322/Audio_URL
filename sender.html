<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音響通信 - 送信側</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 1em;
        }

        .container {
            max-width: 600px;
            margin: auto;
        }

        .section {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        h2 {
            margin-top: 0;
        }

        input[type="text"] {
            width: 90%;
            padding: 8px;
            margin-bottom: 8px;
        }

        button {
            padding: 10px 15px;
            font-size: 16px;
            margin-right: 8px;
        }

        #status-tx {
            color: #28a745;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>音響通信 (送信専用)</h1>
        <div style="margin-bottom: 15px;">
            <button onclick="location.href='receiver.html'">受信側へ</button>
            <button onclick="location.href='version2.0.html'">送受信デモへ</button>
        </div>
        <p style="background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 5px;">
            ⚠️ **注意: PCのスピーカー音量を100%に設定してください。**
        </p>

        <div class="section">
            <h2>送信側 (Sender)</h2>
            <input type="text" id="urlInput" value="https://www.teu.ac.jp/" style="width: 300px;">
            <button id="sendButton">送信</button>
            <p>ステータス: <span id="status-tx">待機中</span></p>
        </div>
    </div>

    <script>
        // --- 共通設定 (v25の安定設定) ---
        const FREQ_0 = 1750; // '0' の周波数 (Hz)
        const FREQ_1 = 2000; // '1' の周波数 (Hz)
        const FREQ_START = 1500; // 開始信号
        const FREQ_END = 2250; // 終了信号 (分離)

        const START_DURATION = 500; // 開始信号の長さ (ミリ秒)
        const END_DURATION = 500;   // 終了信号の長さ (ミリ秒)
        const BIT_DURATION = 400; // 1ビットあたりの再生時間 (ミリ秒)
        const CHAR_PAUSE = 400; // 文字間ポーズ
        // ---

        // === UI要素 (グローバル) ===
        const sendButton = document.getElementById('sendButton');
        const urlInput = document.getElementById('urlInput');
        const statusTx = document.getElementById('status-tx');

        // === 送信側 (SENDER) のロジック ===
        let txAudioContext;

        async function playTone(frequency, duration) {
            if (!txAudioContext || txAudioContext.state === 'closed') {
                txAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const oscillator = txAudioContext.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, txAudioContext.currentTime);

            const gainNode = txAudioContext.createGain();
            gainNode.gain.setValueAtTime(0, txAudioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(1.0, txAudioContext.currentTime + 0.01);
            gainNode.gain.linearRampToValueAtTime(0, txAudioContext.currentTime + (duration / 1000) - 0.01);

            oscillator.connect(gainNode);
            gainNode.connect(txAudioContext.destination);

            oscillator.start(txAudioContext.currentTime);
            oscillator.stop(txAudioContext.currentTime + (duration / 1000));

            return new Promise(resolve => setTimeout(resolve, duration));
        }

        function stringToBinaryArray(str) {
            return str.split('').map(char => {
                const bin = char.charCodeAt(0).toString(2);
                return '0'.repeat(8 - bin.length) + bin;
            });
        }

        sendButton.onclick = async () => {
            if (txAudioContext && txAudioContext.state === 'running') {
                await txAudioContext.close();
            }

            const textToSend = urlInput.value;
            if (!textToSend) {
                alert('送信するテキストを入力してください');
                return;
            }

            // 送信ログは受信側に表示されるため、送信側からは削除

            const binaryChars = stringToBinaryArray(textToSend);
            statusTx.textContent = '送信中...';
            sendButton.disabled = true;

            await playTone(FREQ_START, START_DURATION);

            for (const charBits of binaryChars) {
                for (const bit of charBits) {
                    const freq = (bit === '0') ? FREQ_0 : FREQ_1;
                    await playTone(freq, BIT_DURATION);
                }
                await new Promise(resolve => setTimeout(resolve, CHAR_PAUSE));
            }

            await playTone(FREQ_END, END_DURATION);

            statusTx.textContent = `送信完了: ${binaryChars.length * 8} ビット`;
            sendButton.disabled = false;
        };
    </script>
</body>

</html>