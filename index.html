<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³éŸ¿é€šä¿¡ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            font-family: sans-serif;
            padding: 1em;
            margin: 0;
        }

        .container {
            max-width: 600px;
            margin: auto;
        }

        .section {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        h2 {
            margin-top: 0;
        }

        input[type="text"] {
            width: 90%;
            padding: 8px;
            margin-bottom: 8px;
        }

        button {
            padding: 10px 15px;
            font-size: 16px;
            margin-right: 8px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: background 0.3s;
        }

        #sendButton {
            background: #28a745;
            color: white;
        }

        #sendButton:hover {
            background: #218838;
        }

        #listenButton {
            background: #007bff;
            color: white;
        }

        #listenButton:hover {
            background: #0056b3;
        }

        #resetButton {
            background: #ffc107;
        }

        #resetButton:hover {
            background: #e0a800;
        }

        #status-rx {
            color: #007bff;
        }

        #status-tx {
            color: #28a745;
        }

        #binaryResult {
            word-break: break-all;
        }

        #textResult {
            color: #dc3545;
            font-weight: bold;
        }

        #charLog {
            height: 100px;
            overflow-y: scroll;
            border: 1px solid #eee;
            padding: 5px;
            background: #f8f9fa;
        }

        .log-entry {
            margin-bottom: 3px;
        }

        .log-tx {
            color: #007bff;
            font-weight: bold;
        }

        .log-rx {
            color: #dc3545;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>éŸ³éŸ¿é€šä¿¡ã‚·ã‚¹ãƒ†ãƒ </h1>

        <p class="warning-box">
            âš ï¸ <strong>æ³¨æ„: PCã®ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼éŸ³é‡ã‚’100%ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚</strong>
        </p>

        <!-- é€ä¿¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ğŸ“¤ é€ä¿¡å´ (Sender)</h2>
            <input type="text" id="urlInput" value="https://www.teu.ac.jp/" style="width: 300px;">
            <button id="sendButton">é€ä¿¡</button>
            <p>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="status-tx">å¾…æ©Ÿä¸­</span></p>
        </div>

        <!-- å—ä¿¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ğŸ“¥ å—ä¿¡å´ (Receiver)</h2>
            <button id="listenButton">å—ä¿¡é–‹å§‹</button>
            <button id="resetButton">ãƒªã‚»ãƒƒãƒˆ</button>
            <p>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="status-rx">å¾…æ©Ÿä¸­</span></p>
            <p><b>å—ä¿¡ãƒã‚¤ãƒŠãƒª:</b> <span id="binaryResult"></span></p>
            <p><b>å—ä¿¡ãƒ†ã‚­ã‚¹ãƒˆ:</b> <span id="textResult"></span></p>

            <h4>å—ä¿¡ãƒ­ã‚°</h4>
            <div id="charLog"></div>

            <p style="font-size: 0.8em; color: #666; margin-top: 15px;">
                <span id="debug-volume">...</span>
            </p>
        </div>
    </div>

    <script>
        // --- å…±é€šè¨­å®š ---
        const FREQ_0 = 1750; // '0' ã®å‘¨æ³¢æ•° (Hz)
        const FREQ_1 = 2000; // '1' ã®å‘¨æ³¢æ•° (Hz)
        const FREQ_START = 1500; // é–‹å§‹ä¿¡å·
        const FREQ_END = 2250; // çµ‚äº†ä¿¡å·

        const START_DURATION = 500; // é–‹å§‹ä¿¡å·ã®é•·ã• (ãƒŸãƒªç§’)
        const END_DURATION = 500;   // çµ‚äº†ä¿¡å·ã®é•·ã• (ãƒŸãƒªç§’)
        const BIT_DURATION = 400; // 1ãƒ“ãƒƒãƒˆã‚ãŸã‚Šã®å†ç”Ÿæ™‚é–“ (ãƒŸãƒªç§’)
        const CHAR_PAUSE = 400; // æ–‡å­—é–“ãƒãƒ¼ã‚º
        const THRESHOLD = -140; // ã—ãã„å€¤ï¼ˆ-136dBã®éŸ³ã‚’æ‹¾ãˆã‚‹ã‚ˆã†ã«-140ã«è¨­å®šï¼‰

        console.log('=== éŸ³éŸ¿é€šä¿¡ã‚·ã‚¹ãƒ†ãƒ èµ·å‹• ===');
        console.log('è¨­å®š: ã—ãã„å€¤=' + THRESHOLD + 'dB (ç’°å¢ƒéŸ³ãŒç´„-136dBã®å ´åˆã«æœ€é©)');
        console.log('FREQ_START=' + FREQ_START + 'Hz, FREQ_0=' + FREQ_0 + 'Hz, FREQ_1=' + FREQ_1 + 'Hz, FREQ_END=' + FREQ_END + 'Hz');

        // === UIè¦ç´  ===
        const sendButton = document.getElementById('sendButton');
        const urlInput = document.getElementById('urlInput');
        const statusTx = document.getElementById('status-tx');
        const listenButton = document.getElementById('listenButton');
        const statusRx = document.getElementById('status-rx');
        const binaryResult = document.getElementById('binaryResult');
        const textResult = document.getElementById('textResult');
        const debugVolume = document.getElementById('debug-volume');
        const resetButton = document.getElementById('resetButton');
        const charLog = document.getElementById('charLog');        // === é€ä¿¡å´ã®ãƒ­ã‚¸ãƒƒã‚¯ ===
        let txAudioContext;

        async function playTone(frequency, duration) {
            if (!txAudioContext || txAudioContext.state === 'closed') {
                txAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const oscillator = txAudioContext.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, txAudioContext.currentTime);

            const gainNode = txAudioContext.createGain();
            gainNode.gain.setValueAtTime(0, txAudioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(30.0, txAudioContext.currentTime + 0.01); // éŸ³é‡ã‚’30å€ã«å¢—å¹…
            gainNode.gain.linearRampToValueAtTime(0, txAudioContext.currentTime + (duration / 1000) - 0.01);

            oscillator.connect(gainNode);
            gainNode.connect(txAudioContext.destination);

            oscillator.start(txAudioContext.currentTime);
            oscillator.stop(txAudioContext.currentTime + (duration / 1000));

            return new Promise(resolve => setTimeout(resolve, duration));
        }

        function stringToBinaryArray(str) {
            return str.split('').map(char => {
                const bin = char.charCodeAt(0).toString(2);
                return '0'.repeat(8 - bin.length) + bin;
            });
        }

        sendButton.onclick = async () => {
            if (txAudioContext && txAudioContext.state === 'running') {
                await txAudioContext.close();
            }

            const textToSend = urlInput.value;
            if (!textToSend) {
                alert('é€ä¿¡ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            console.log('=== é€ä¿¡é–‹å§‹ ===');
            console.log('é€ä¿¡ãƒ†ã‚­ã‚¹ãƒˆ:', textToSend);

            // é€ä¿¡ãƒ­ã‚°ã‚’è¿½åŠ 
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry log-tx';
            logEntry.textContent = `[é€ä¿¡] ${textToSend}`;
            charLog.appendChild(logEntry);
            charLog.scrollTop = charLog.scrollHeight;

            const binaryChars = stringToBinaryArray(textToSend);
            console.log('ãƒã‚¤ãƒŠãƒªå¤‰æ›:', binaryChars.map((b, i) => textToSend[i] + '=' + b).join(', '));

            statusTx.textContent = 'é€ä¿¡ä¸­...';
            sendButton.disabled = true;

            console.log('â†’ é–‹å§‹ä¿¡å·é€ä¿¡ (' + FREQ_START + 'Hz, ' + START_DURATION + 'ms)');
            await playTone(FREQ_START, START_DURATION);

            for (let i = 0; i < binaryChars.length; i++) {
                const charBits = binaryChars[i];
                console.log('â†’ æ–‡å­—' + (i + 1) + ' "' + textToSend[i] + '" ãƒ“ãƒƒãƒˆåˆ—: ' + charBits);
                for (const bit of charBits) {
                    const freq = (bit === '0') ? FREQ_0 : FREQ_1;
                    await playTone(freq, BIT_DURATION);
                }
                await new Promise(resolve => setTimeout(resolve, CHAR_PAUSE));
            }

            console.log('â†’ çµ‚äº†ä¿¡å·é€ä¿¡ (' + FREQ_END + 'Hz, ' + END_DURATION + 'ms)');
            await playTone(FREQ_END, END_DURATION);

            console.log('=== é€ä¿¡å®Œäº† ===');
            statusTx.textContent = `é€ä¿¡å®Œäº†: ${binaryChars.length * 8} ãƒ“ãƒƒãƒˆ`;
            sendButton.disabled = false;
        };

        // === å—ä¿¡å´ã®ãƒ­ã‚¸ãƒƒã‚¯ ===
        let rxAudioContext;
        let analyser;
        let microphoneStream;
        let dataArray;
        let isListening = false;
        let receivedBinary = '';
        let receiveState = 'IDLE';
        let nextBitStartTime = 0;
        let expectedChars = 0;
        let bitsReceived = 0;
        let absoluteStartTime = 0;
        let analyzeCount = 0; // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼

        function binaryToString(bin) {
            let str = '';
            for (let i = 0; i < bin.length; i += 8) {
                const byte = bin.substr(i, 8);
                if (byte.length === 8) {
                    str += String.fromCharCode(parseInt(byte, 2));
                }
            }
            return str;
        }

        function analyze() {
            if (!isListening) return;
            requestAnimationFrame(analyze);

            analyser.getFloatFrequencyData(dataArray);

            const targetBinSize = rxAudioContext.sampleRate / analyser.fftSize;

            const freq0Index = Math.round(FREQ_0 / targetBinSize);
            const freq1Index = Math.round(FREQ_1 / targetBinSize);
            const freqStartIndex = Math.round(FREQ_START / targetBinSize);
            const freqEndIndex = Math.round(FREQ_END / targetBinSize);

            const freq0Db = dataArray[freq0Index];
            const freq1Db = dataArray[freq1Index];
            const freqStartDb = dataArray[freqStartIndex];
            const freqEndDb = dataArray[freqEndIndex];

            const now = Date.now();

            // 100ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«ç¾åœ¨ã®éŸ³é‡ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
            analyzeCount++;
            if (analyzeCount % 100 === 0) {
                const maxDb = Math.max(freqStartDb, freq0Db, freq1Db, freqEndDb);
                console.log('[å—ä¿¡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°] æœ€å¤§dB=' + maxDb.toFixed(1) + ', Start=' + freqStartDb.toFixed(1) + ', F0=' + freq0Db.toFixed(1) + ', F1=' + freq1Db.toFixed(1) + ', End=' + freqEndDb.toFixed(1) + ' (ã—ãã„å€¤=' + THRESHOLD + 'dB)');
            }

            // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºã‚’å¼·èª¿è¡¨ç¤ºä»˜ãã«å¤‰æ›´
            const maxDb = Math.max(freqStartDb, freq0Db, freq1Db, freqEndDb);
            const startStyle = freqStartDb === maxDb && freqStartDb > THRESHOLD ? 'color: red; font-weight: bold;' : '';
            const f0Style = freq0Db === maxDb && freq0Db > THRESHOLD ? 'color: red; font-weight: bold;' : '';
            const f1Style = freq1Db === maxDb && freq1Db > THRESHOLD ? 'color: red; font-weight: bold;' : '';
            const endStyle = freqEndDb === maxDb && freqEndDb > THRESHOLD ? 'color: red; font-weight: bold;' : '';

            debugVolume.innerHTML = `
                <span style="${startStyle}">Start(1.5k): ${freqStartDb.toFixed(1)}dB</span> | 
                <span style="${f0Style}">F0(1.75k): ${freq0Db.toFixed(1)}dB</span> | 
                <span style="${f1Style}">F1(2.0k): ${freq1Db.toFixed(1)}dB</span> | 
                <span style="${endStyle}">End(2.25k): ${freqEndDb.toFixed(1)}dB</span> | 
                ã—ãã„å€¤: ${THRESHOLD}dB
            `;

            if (receiveState === 'IDLE') {
                // é–‹å§‹ä¿¡å·æ¤œå‡ºï¼š1.5kHzãŒä»–ã‚ˆã‚Šå¤§ããã€ã‹ã¤ååˆ†ã«å¼·ã„ä¿¡å·
                // ãƒãƒ©ãƒ³ã‚¹èª¿æ•´: 3dBå·® + ã—ãã„å€¤ã‚ˆã‚Š14dBä»¥ä¸Šå¤§ãã„(-126dBä»¥ä¸Š)
                if (freqStartDb > (THRESHOLD + 14) &&
                    freqStartDb > (freq0Db + 3) &&
                    freqStartDb > (freq1Db + 3) &&
                    freqStartDb > (freqEndDb + 3)) {
                    console.log('=== å—ä¿¡é–‹å§‹ ===');
                    console.log('ã‚¹ã‚¿ãƒ¼ãƒˆä¿¡å·æ¤œå‡ºï¼ Start=' + freqStartDb.toFixed(1) + 'dB (ã—ãã„å€¤=' + THRESHOLD + 'dB)');
                    console.log('æ¯”è¼ƒ: F0=' + freq0Db.toFixed(1) + ', F1=' + freq1Db.toFixed(1) + ', End=' + freqEndDb.toFixed(1));
                    console.log('å·®åˆ†: Start-F0=' + (freqStartDb - freq0Db).toFixed(1) + ', Start-F1=' + (freqStartDb - freq1Db).toFixed(1) + ', Start-End=' + (freqStartDb - freqEndDb).toFixed(1));

                    statusRx.textContent = 'å—ä¿¡é–‹å§‹ï¼';
                    receiveState = 'RECEIVING';

                    expectedChars = 0; // æ–‡å­—æ•°ä¸æ˜ã§å—ä¿¡
                    bitsReceived = 0;

                    receivedBinary = '';
                    binaryResult.textContent = '';
                    textResult.textContent = '';

                    absoluteStartTime = now;
                    nextBitStartTime = absoluteStartTime + (START_DURATION - 50) + (BIT_DURATION / 2);
                    console.log('æ¬¡ã®ãƒ“ãƒƒãƒˆæ¤œå‡ºäºˆå®šæ™‚åˆ»:', new Date(nextBitStartTime).toISOString());
                }
            }
            else if (receiveState === 'RECEIVING') {
                if (now > nextBitStartTime) {
                    let bit = '';

                    console.log('--- ãƒ“ãƒƒãƒˆæ¤œå‡ºã‚¿ã‚¤ãƒŸãƒ³ã‚° (ãƒ“ãƒƒãƒˆç•ªå·=' + bitsReceived + ') ---');
                    console.log('dBå€¤: Start=' + freqStartDb.toFixed(1) + ', F0=' + freq0Db.toFixed(1) + ', F1=' + freq1Db.toFixed(1) + ', End=' + freqEndDb.toFixed(1));

                    // 8ãƒ“ãƒƒãƒˆ(1æ–‡å­—)å—ä¿¡å¾Œã¯ã€çµ‚äº†ä¿¡å·æ¤œå‡ºã‚’ç·©å’Œ
                    // æ¡ä»¶: EndãŒæœ€å¤§ OR (EndãŒã—ãã„å€¤ä»¥ä¸Š ã‹ã¤ ä»–ã‚ˆã‚Š0.5dBä»¥ä¸Šå¤§ãã„)
                    const endIsMax = (freqEndDb >= freqStartDb && freqEndDb >= freq0Db && freqEndDb >= freq1Db);
                    const endIsStrong = (freqEndDb > THRESHOLD &&
                        freqEndDb > (freqStartDb + 0.5) &&
                        freqEndDb > (freq0Db + 0.5) &&
                        freqEndDb > (freq1Db + 0.5));

                    if (bitsReceived >= 8 && (endIsMax || endIsStrong)) {
                        console.log('çµ‚äº†ä¿¡å·æ¤œå‡ºï¼ End=' + freqEndDb.toFixed(1) + 'dB (æœ€å¤§å€¤=' + endIsMax + ', å¼·åº¦=' + endIsStrong + ')');
                        console.log('å·®åˆ†: End-Start=' + (freqEndDb - freqStartDb).toFixed(1) + ', End-F0=' + (freqEndDb - freq0Db).toFixed(1) + ', End-F1=' + (freqEndDb - freq1Db).toFixed(1));
                        console.log('å—ä¿¡å®Œäº†: ' + bitsReceived + 'ãƒ“ãƒƒãƒˆ = ' + (bitsReceived / 8) + 'æ–‡å­—');
                        console.log('å—ä¿¡ãƒã‚¤ãƒŠãƒª: ' + receivedBinary);
                        console.log('å—ä¿¡ãƒ†ã‚­ã‚¹ãƒˆ: ' + binaryToString(receivedBinary));
                        console.log('=== å—ä¿¡çµ‚äº† ===');

                        statusRx.textContent = 'å—ä¿¡å®Œäº†ï¼ˆçµ‚äº†ä¿¡å·å—ä¿¡ï¼‰';
                        receiveState = 'IDLE';
                        return;
                    }

                    // '0' ã®ä¿¡å·(1.75k)ã‹ï¼Ÿï¼ˆ3dBå·® + çµ¶å¯¾ãƒ¬ãƒ™ãƒ«ç¢ºèªã§æ¤œå‡ºï¼‰
                    else if (freq0Db > (THRESHOLD + 14) &&
                        freq0Db > (freqStartDb + 3) &&
                        freq0Db > (freq1Db + 3) &&
                        freq0Db > (freqEndDb + 3)) {
                        bit = '0';
                        console.log('â†’ ãƒ“ãƒƒãƒˆ ' + bitsReceived + ': "0" æ¤œå‡º (F0=' + freq0Db.toFixed(1) + 'dB)');
                        console.log('  å·®åˆ†: F0-Start=' + (freq0Db - freqStartDb).toFixed(1) + ', F0-F1=' + (freq0Db - freq1Db).toFixed(1) + ', F0-End=' + (freq0Db - freqEndDb).toFixed(1));
                    }
                    // '1' ã®ä¿¡å·(2.0k)ã‹ï¼Ÿï¼ˆ3dBå·® + çµ¶å¯¾ãƒ¬ãƒ™ãƒ«ç¢ºèªã§æ¤œå‡ºï¼‰
                    else if (freq1Db > (THRESHOLD + 14) &&
                        freq1Db > (freqStartDb + 3) &&
                        freq1Db > (freq0Db + 3) &&
                        freq1Db > (freqEndDb + 3)) {
                        bit = '1';
                        console.log('â†’ ãƒ“ãƒƒãƒˆ ' + bitsReceived + ': "1" æ¤œå‡º (F1=' + freq1Db.toFixed(1) + 'dB)');
                        console.log('  å·®åˆ†: F1-Start=' + (freq1Db - freqStartDb).toFixed(1) + ', F1-F0=' + (freq1Db - freq0Db).toFixed(1) + ', F1-End=' + (freq1Db - freqEndDb).toFixed(1));
                    }
                    else {
                        // ä¿¡å·ãŒæ˜ç¢ºã§ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ¬¡ã®ãƒ“ãƒƒãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¾ã§å¾…ã¤ï¼‰
                        console.log('â†’ ä¿¡å·ä¸æ˜ç­ã€ã‚¹ã‚­ãƒƒãƒ— (æœ€å¤§dB=' + maxDb.toFixed(1) + ', ã—ãã„å€¤=' + THRESHOLD + ')');
                        // ã‚¹ã‚­ãƒƒãƒ—æ™‚ã¯æ¬¡ã®ãƒ“ãƒƒãƒˆæ¤œå‡ºæ™‚åˆ»ã¾ã§å¤§ããã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆBIT_DURATIONåˆ†é€²ã‚ã‚‹ï¼‰
                        nextBitStartTime = nextBitStartTime + BIT_DURATION;
                        return; // ãƒ“ãƒƒãƒˆæ•°ã‚’å¢—ã‚„ã•ãšã«æ¬¡ã®ãƒ“ãƒƒãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¸
                    }

                    receivedBinary += bit;
                    binaryResult.textContent = receivedBinary;
                    bitsReceived++;                    // â–¼ æ¬¡ã®ãƒ“ãƒƒãƒˆã®ã€Œçµ¶å¯¾æ™‚åˆ»ã€ã‚’å†è¨ˆç®—
                    const charsSoFar = Math.floor(bitsReceived / 8);
                    const pausesSoFar = charsSoFar;
                    nextBitStartTime = absoluteStartTime + (START_DURATION - 50) + (BIT_DURATION * (bitsReceived + 0.5)) + (CHAR_PAUSE * pausesSoFar);

                    if (bitsReceived > 0 && bitsReceived % 8 === 0) {
                        const lastByte = receivedBinary.slice(-8);
                        const lastChar = binaryToString(lastByte);

                        textResult.textContent = binaryToString(receivedBinary);

                        console.log('âœ“ 1æ–‡å­—å®Œæˆ: "' + lastChar + '" (ASCII=' + lastChar.charCodeAt(0) + ', ãƒã‚¤ãƒŠãƒª=' + lastByte + ')');

                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry log-rx';
                        logEntry.textContent = `[å—ä¿¡] ${lastChar} (ãƒã‚¤ãƒŠãƒª: ${lastByte})`;
                        charLog.appendChild(logEntry);
                        charLog.scrollTop = charLog.scrollHeight;
                    }
                }

                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¤å®š: 8ãƒ“ãƒƒãƒˆä»¥ä¸Šå—ä¿¡å¾Œã€2ç§’é–“æ–°ã—ã„ãƒ“ãƒƒãƒˆãŒæ¥ãªã‘ã‚Œã°çµ‚äº†
                if (bitsReceived >= 8 && (now - nextBitStartTime) > 2000) {
                    console.log('=== å—ä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ ===');
                    console.log('å—ä¿¡å®Œäº†: ' + bitsReceived + 'ãƒ“ãƒƒãƒˆ = ' + Math.floor(bitsReceived / 8) + 'æ–‡å­— (ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ)');
                    console.log('å—ä¿¡ãƒã‚¤ãƒŠãƒª: ' + receivedBinary);
                    console.log('å—ä¿¡ãƒ†ã‚­ã‚¹ãƒˆ: ' + binaryToString(receivedBinary));
                    statusRx.textContent = 'å—ä¿¡å®Œäº†ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰';
                    receiveState = 'IDLE';
                }
            }
        }

        async function startListening() {
            if (isListening) return; // æ—¢ã«å—ä¿¡ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„

            try {
                statusRx.textContent = 'ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚ä¸­...';
                console.log('=== å—ä¿¡æº–å‚™é–‹å§‹ ===');

                const constraints = {
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        // ãƒã‚¤ã‚¯æ„Ÿåº¦ã‚’æœ€å¤§åŒ–
                        sampleRate: 48000,
                        channelCount: 1
                    },
                    video: false
                };
                microphoneStream = await navigator.mediaDevices.getUserMedia(constraints);

                rxAudioContext = new (window.AudioContext || window.webkitAudioContext)();

                analyser = rxAudioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0; // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ã‚’å‘ä¸Š
                dataArray = new Float32Array(analyser.frequencyBinCount);

                const source = rxAudioContext.createMediaStreamSource(microphoneStream);

                // ãƒã‚¤ã‚¯å…¥åŠ›ã‚’å¢—å¹…
                const gainNode = rxAudioContext.createGain();
                gainNode.gain.value = 2.0; // ãƒã‚¤ã‚¯å…¥åŠ›ã‚’2å€ã«å¢—å¹…

                source.connect(gainNode);
                gainNode.connect(analyser);

                isListening = true;
                listenButton.textContent = 'å—ä¿¡åœæ­¢';
                listenButton.style.background = '#dc3545'; // èµ¤è‰²ã«å¤‰æ›´
                statusRx.textContent = 'é–‹å§‹ä¿¡å·ã‚’å¾…ã£ã¦ã„ã¾ã™...';

                console.log('ãƒã‚¤ã‚¯å—ä¿¡é–‹å§‹ï¼');
                console.log('ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆ:', rxAudioContext.sampleRate + 'Hz');
                console.log('FFTã‚µã‚¤ã‚º:', analyser.fftSize);
                console.log('å‘¨æ³¢æ•°ãƒ“ãƒ³å¹…:', (rxAudioContext.sampleRate / analyser.fftSize).toFixed(2) + 'Hz');
                console.log('=== å—ä¿¡å¾…æ©Ÿä¸­ ===');

                analyze();

            } catch (err) {
                console.error('ãƒã‚¤ã‚¯ã‚¨ãƒ©ãƒ¼:', err);
                alert('ãƒã‚¤ã‚¯ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                statusRx.textContent = 'ãƒã‚¤ã‚¯å–å¾—ã‚¨ãƒ©ãƒ¼';
            }
        } function stopListening() {
            isListening = false;
            receiveState = 'IDLE';
            listenButton.textContent = 'å—ä¿¡é–‹å§‹';
            listenButton.style.background = '#007bff'; // é’è‰²ã«æˆ»ã™
            statusRx.textContent = 'åœæ­¢ä¸­';

            if (microphoneStream) {
                microphoneStream.getTracks().forEach(track => track.stop());
                console.log('ãƒã‚¤ã‚¯åœæ­¢');
            }
            if (rxAudioContext && rxAudioContext.state !== 'closed') {
                rxAudioContext.close();
            }
        }

        listenButton.onclick = () => {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        };

        resetButton.onclick = () => {
            receivedBinary = '';
            binaryResult.textContent = '';
            textResult.textContent = '';
            charLog.innerHTML = '';
            console.log('ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ');

            if (isListening) {
                statusRx.textContent = 'é–‹å§‹ä¿¡å·ã‚’å¾…ã£ã¦ã„ã¾ã™...';
                receiveState = 'IDLE';
                bitsReceived = 0;
                expectedChars = 0;
                absoluteStartTime = 0;
            } else {
                statusRx.textContent = 'ãƒªã‚»ãƒƒãƒˆå®Œäº†';
            }
        };

    </script>
</body>

</html>